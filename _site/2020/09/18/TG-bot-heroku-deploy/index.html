<!doctype html>
<html lang="en">
 
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      Питонячий Телеграм-Бот, Yandex-API и диплой на Heroku. &middot; AndreyMelnikov.MyBlog
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/assets/apple-touch-icon-precomposed.ico" type="image/vnd.microsoft.icon">
  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.ico?">
  <link rel="alternate" type="application/atom+xml" title="AndreyMelnikov.MyBlog" href="/atom.xml">


  <!-- Begin Jekyll SEO tag v2.6.1 -->
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Питонячий Телеграм-Бот, Yandex-API и диплой на Heroku." />
<meta name="author" content="Andrey Melnikov" />
<meta property="og:locale" content="en_US" />
<link rel="canonical" href="http://localhost:4000/2020/09/18/TG-bot-heroku-deploy/" />
<meta property="og:url" content="http://localhost:4000/2020/09/18/TG-bot-heroku-deploy/" />
<meta property="og:site_name" content="AndreyMelnikov.MyBlog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-09-18T00:00:00+03:00" />
<script type="application/ld+json">
{"datePublished":"2020-09-18T00:00:00+03:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/09/18/TG-bot-heroku-deploy/"},"url":"http://localhost:4000/2020/09/18/TG-bot-heroku-deploy/","author":{"@type":"Person","name":"Andrey Melnikov"},"headline":"Питонячий Телеграм-Бот, Yandex-API и диплой на Heroku.","dateModified":"2020-09-18T00:00:00+03:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>
	<table>
	<p></p>
	</table>
    <div class="container content">
	
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">AndreyMelnikov.MyBlog</a>
          <small>   # мой блог: IT-марафон.</small>
        </h3>
		<p><img src="/image/my_avatar.jpeg"</p>
      </header>

      <main>
        <article class="post">
  <h1 class="post-title">Питонячий Телеграм-Бот, Yandex-API и диплой на Heroku.</h1>
  <time datetime="2020-09-18T00:00:00+03:00" class="post-date">18 Sep 2020</time>
  <p><img src="/image/post-2020-09-18/logo.JPG" alt="" /></p>

<p>На сегодняшний день, наверное, только ленивый не писал и не делал обзорных статей с инструкциями как запилить собственного телеграм-бота. Это уже такой своеобразный мейнстрим на сегодня, особенно среди питонистов.<br />
В данном посте я хотел бы затронуть не столько процесс написания самого бота, сколько описать в целом процесс интеграции кода на питоне с телеграм-сервисом, сторонним API по геокодированию от Yandex и развертыванию этого всего на удаленном бесплатном хостинге Heroku.</p>

<p>Итак, попалось мне как-то одно тестовое задание, где требовалось написать телеграм-бота с возможностью обрабатывать запросы пользователя в виде текста с частичным упоминанием географических адресов. В ответ пользователь должен получить полный структурированный адрес географического объекта. На этом задание конечно не исчерпывалось, но остальное я опишу возможно в другой раз :)</p>

<p>Чтобы написать бота, я использовал питонячую библиотеку <a href="https://github.com/python-telegram-bot/python-telegram-bot"><strong><code class="highlighter-rouge">python-telegram-bot</code></strong></a>. Там все достаточно понятно. Есть официальная документация и масса примеров в сети. Если коротко описать процесс создания самого бота, то для этого необходимо:</p>

<ul>
  <li>Создать и зарегистрировать своего бота.<br />
Для этого в сервисе телеграм необходимо отправить Боту-Отцу (<strong><code class="highlighter-rouge">@BotFather</code></strong>) команду <strong><code class="highlighter-rouge">/newbot</code></strong>.<br />
Дать боту имя (name) и имя пользователя (username).<br />
В ответ Папа-Бот вышлет уникальный API-ключ (TOKEN) для вашего бота. Данный ключ является идентификатором для доступа и управления ботом. Его нужно сохранить и держать в тайне, иначе бота могут угнать! (Не размещать в коде в публичном доступе на открытых ресурсах, например).</li>
</ul>

<p><img src="/image/post-2020-09-18/bot-father.JPG" alt="" /></p>

<ul>
  <li>Собственно, написать код (логику работы нашего бота), используя любую подходящую библиотечку для телеграм:)
В коде мы используем полученный ранее API ключ, для взаимодействия с сервером телеграм.<br />
Структура каталога нашего бота в общем случае должна содержать следующие файлы:
<strong><code class="highlighter-rouge">__init.py__</code></strong> - необходим, чтобы Python рассматривал каталог, как содержащий пакеты для корректного импорта.<br />
<strong><code class="highlighter-rouge">main.py</code></strong> – сам код (логика) бота.<br />
<strong><code class="highlighter-rouge">config.py</code></strong> – указываем наши токены, которые потом импортируются в <code class="highlighter-rouge">mian.py</code>.<br />
Вот так, если упрощенно представить на схеме, все и происходит:</li>
</ul>

<p><img src="/image/post-2020-09-18/how_it_works.png" alt="" /></p>

<ul>
  <li>Запустить главный файл <code class="highlighter-rouge">main.py</code> на исполнение, и писать запросы нашему боту в телеграм-сервисе.</li>
</ul>

<p>Создав бота, пришло время дать ему дополнительный функционал. Поскольку цель состоит в том, чтобы бот взаимодействовал с API геокодера, отвечая на запросы пользователя полным адресом географического объекта. Для данной цели подходит <a href="https://yandex.ru/dev/maps/geocoder/doc/desc/concepts/about.html/"><strong>API от Yandex</strong></a>. Для бесплатного использования необходимо зарегистрироваться. При регистрации указать некоммерческое использование и после этого нам будет доступно 25000 запросов к API в сутки.<br />
В ответ мы получим также API ключ, который необходимо использовать в коде бота для взаимодействия с Yandex геокодером.<br />
Yandex геокодер использует прямое и обратное геокодирование. То есть, умеет отвечать полным адресом на текстовый запрос или координаты, и наоборот - отправлять координаты по указанному адресу. 
В коде бота достаточно описать функцию обработчик для запросов пользователя, которая будет формировать запрос, затем парсить ответ от Yandex и выводить ответ пользователю в телеграм-клиент. На официальной странице API Yandex геокодера все достаточно понятно описано.</p>

<p>И вот когда бот написан и отлажен, пришло время дать ему онлайн-доступность. Потому, что до сих пор он работал только при условии запущенного <code class="highlighter-rouge">main.py</code> файла на локальном компьютере с доступом в интернет. 
Для бесплатного хостинга подобных проектов подходит сервис <a href="https://heroku.com"><strong>Heroku</strong></a> и созданный в нем активный аккаунт. Кроме того нам понадобится <code class="highlighter-rouge">Heroku Command Line Interface</code> (CLI) , который можно скачать <a href="https://devcenter.heroku.com/articles/getting-started-with-python#set-up">тут</a>, а также <a href="https://git-scm.com/book/en/v2/Getting-Started-Installing-Git">Git.</a></p>

<p>Добавим в директорию нашего бота еще пару файлов <strong><code class="highlighter-rouge">Procfile</code></strong> и <strong><code class="highlighter-rouge">requirements.txt</code></strong>:</p>

<p><strong><code class="highlighter-rouge">Procfile</code></strong> – текстовый, но без расширения. Для этого необходимо использовать сохранение через Notepad++ (опция All-typs (<em>.</em>))<br />
Содержание файла:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>worker: python main.py
</code></pre></div></div>

<p><strong><code class="highlighter-rouge">requirements.txt</code></strong> – обычный текстовый.<br />
Содержание файла:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>appdirs==1.4.3
certifi==2018.1.18
Cython==0.23
Django==1.10.6
docutils==0.13.1
packaging==16.8
pipenv==11.8.0
psutil==5.0.1
pyowm==2.8.0
Pygments==2.2.0
pyparsing==2.2.0
pyTelegramBotAPI==3.6.1
python-telegram-bot==13.0.0
requests==2.13.0
six==1.10.0
virtualenv==15.1.0
virtualenv-clone==0.3.0
</code></pre></div></div>
<p>Это необходимые компоненты для виртуального окружения на сервере. Конечно, всего этого нам сейчас и не нужно, но пусть будет:) Главное, чтобы необходимые нам библиотеки и фреймворки были нужной версии.
После того, как оба файла добавлены в каталог с ботом, необходимо запушить все на гитхаб в отдельный репозиторий, предварительно удалив из кода API токены (помним про безопасность).<br />
Теперь у нас всё готово для загрузки бота на Heroku.<br />
Вернем токены обратно в наш код и приступим к диплою. Из терминала (командной строки - в моем случае это Git bash):</p>
<ul>
  <li>Логинемся.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> $ heroku login
</code></pre></div>    </div>
    <p>Нажимаем любую клавишу, переходим в браузер, подтверждаем вход.</p>
  </li>
  <li>Создаем проект.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ heroku create
</code></pre></div>    </div>
    <p>Имя будет создано автоматически. Можно также это сделать из-под браузера.</p>
  </li>
  <li>Клонируем каталог с созданным проектом к себе. В данном каталоге должны быть файлы из нашего репозитория с телеграм-ботом.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ heroku git:clone -a hidden-mountain-ххххх
</code></pre></div>    </div>
  </li>
  <li>Переходим в каталог:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cd hidden-mountain-ххххх
</code></pre></div>    </div>
  </li>
  <li>И делаем привычную связку команд для Git: add-commit-push.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git add .
$ git commit -am "my-deploy"
$ git push heroku master
</code></pre></div>    </div>
    <p>После чего несколько минут будут устанавливаться указанные в <code class="highlighter-rouge">requirements.txt</code> компонеты. По завершении процесса, будет запущен <code class="highlighter-rouge">main.py</code> файл как указано в <code class="highlighter-rouge">Procfile</code>. После чего бот должен стать доступным. Если этого не происходит можно сделать команду:</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ heroku ps:scale worker=1
</code></pre></div>    </div>
    <p>Для отладки ошибок можно использовать логирование (именно этот режим позволил мне отловить ошибку импорта из каталога, который я удалил. И из-за этого мой бот не запускался удаленно.):</p>
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ heroku logs
</code></pre></div>    </div>
  </li>
</ul>

<p>Готово! Теперь проверяем бота - он должен работать в удаленном режиме.<br />
Правда тут стоит сделать оговорку. Обычный бесплатный аккаунт на heroku дает вам 550 dyno часов в месяц. При достижении данного лимита, ваше приложение будет автоматически деактивировано. Информацию о текущем состоянии использования часов, можно посмотреть в настройках учетной записи.
Нажмите на свой аватар в правом верхнем углу сайта и выберите <em>Account settings</em>, перейдите во вкладку <em>Billing</em>, а затем в раздел <em>Free Dyno Usage</em>.</p>


</article>




<aside class="related">
  <h3>История постов</h3>
  <ul class="related-posts">
    
      <li>
        <a href="/2021/05/19/programming-universe9/">
          Вселенная программирования. ООП.
          <small><time datetime="2021-05-19T00:00:00+03:00">19 May 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/04/09/programming-universe8/">
          Вселенная программирования. Ключевые концепции ч5 - Абстракция данных.
          <small><time datetime="2021-04-09T00:00:00+03:00">09 Apr 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/04/05/programming-universe7/">
          Вселенная программирования. Ключевые концепции ч4 - Темная сторона параллелизма.
          <small><time datetime="2021-04-05T00:00:00+03:00">05 Apr 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/03/25/programming-universe6/">
          Вселенная программирования. Ключевые концепции ч3 - Параллелизм.
          <small><time datetime="2021-03-25T00:00:00+03:00">25 Mar 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/02/15/programming-universe5/">
          Вселенная программирования. Ключевые концепции ч2 - Замыкания.
          <small><time datetime="2021-02-15T00:00:00+03:00">15 Feb 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/02/02/programming-universe4/">
          Вселенная программирования. Ключевые концепции ч1.
          <small><time datetime="2021-02-02T00:00:00+03:00">02 Feb 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/01/26/programming-universe3/">
          Вселенная программирования. Вычислительные модели – основные характеристики.
          <small><time datetime="2021-01-26T00:00:00+03:00">26 Jan 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2021/01/10/programming-universe2/">
          Вселенная программирования. Глобальный взгляд на проектирование.
          <small><time datetime="2021-01-10T00:00:00+03:00">10 Jan 2021</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/12/25/programming-universe1/">
          Вселенная программирования. Введение.
          <small><time datetime="2020-12-25T00:00:00+03:00">25 Dec 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/11/15/imperativ_programm_function-call2/">
          Императивное программирование. Вызов функций ч2.
          <small><time datetime="2020-11-15T00:00:00+03:00">15 Nov 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/11/11/imperativ_programm_function-call/">
          Императивное программирование. Вызов функций, нити исполнения кода.
          <small><time datetime="2020-11-11T00:00:00+03:00">11 Nov 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/09/18/TG-bot-heroku-deploy/">
          Питонячий Телеграм-Бот, Yandex-API и диплой на Heroku.
          <small><time datetime="2020-09-18T00:00:00+03:00">18 Sep 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/07/28/FP-base-structs/">
          Функциональное программирование. Элементарные конструкции.
          <small><time datetime="2020-07-28T00:00:00+03:00">28 Jul 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/07/04/Functional-programming/">
          Функциональное программирование. Другой взгляд на мир.
          <small><time datetime="2020-07-04T00:00:00+03:00">04 Jul 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/06/14/Django-button_admin/">
          Django. Своя кнопка в админке.
          <small><time datetime="2020-06-14T00:00:00+03:00">14 Jun 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/05/28/Django-timezone/">
          Django. Время поговорить о времени.
          <small><time datetime="2020-05-28T00:00:00+03:00">28 May 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/05/08/Django-commands_and_pagination-%D0%BA%D0%BE%D0%BF%D0%B8%D1%8F/">
          Django. Пользовательские команды и Пагинация.
          <small><time datetime="2020-05-08T00:00:00+03:00">08 May 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/04/20/Django-scrf/">
          Django. Немного о SCRF.
          <small><time datetime="2020-04-20T00:00:00+03:00">20 Apr 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/04/15/Django-authorization/">
          Django. Авторизация и ограничение доступа.
          <small><time datetime="2020-04-15T00:00:00+03:00">15 Apr 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/04/13/Django-create-rest-api/">
          Django. Быстро прикручиваем REST API к проекту.
          <small><time datetime="2020-04-13T00:00:00+03:00">13 Apr 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/04/12/Django-REST/">
          Django. Знакомство с REST.
          <small><time datetime="2020-04-12T00:00:00+03:00">12 Apr 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/04/01/Django-stop-control/">
          Django. Стоп, контроль!
          <small><time datetime="2020-04-01T00:00:00+03:00">01 Apr 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/03/25/Django/">
          Django, приятно познакомиться.
          <small><time datetime="2020-03-25T00:00:00+03:00">25 Mar 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/02/17/go-to-stage-down/">
          Идем в машинное отделение.
          <small><time datetime="2020-02-17T00:00:00+03:00">17 Feb 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2020/01/23/start-point/">
          Точка старта. Когда ты понимаешь, что твои знания равны нулю)
          <small><time datetime="2020-01-23T00:00:00+03:00">23 Jan 2020</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2019/12/26/blog-building/">
          Pages.GitHub и Jekyll
          <small><time datetime="2019-12-26T00:00:00+03:00">26 Dec 2019</time></small>
        </a>
      </li>
    
      <li>
        <a href="/2019/12/25/my_first_steps/">
          Мой Блог. Начало.
          <small><time datetime="2019-12-25T00:00:00+03:00">25 Dec 2019</time></small>
        </a>
      </li>
    
  </ul>
</aside>

      </main>
	  
	
  

      <footer class="footer">
        <small><font style="color: gray; font-size: 16px; font-family: Arial">
		  <p><a href = 'https://vk.com/amelnikofcode'><font style="color: gray; font-size: 16px; font-family: Arial"> Мой профиль в ВК </font></a></p>
		  <p><a href = 'https://github.com/optima740'><font style="color: gray; font-size: 16px; font-family: Arial"> Мой профиль на GitHub</font></a></p>
		  &copy; <time datetime="2021-05-19T18:33:06+03:00">2021</time>
		</font>  
		  
        </small>
      </footer>
    </div>

    
  </body>
</html>
