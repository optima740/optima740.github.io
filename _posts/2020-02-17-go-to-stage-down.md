---
layout: post
title: Отправляемся на уровень ниже.
---

Изучая языки программирования (в школе – Pascal, в университете – C++, на данный момент - Python) я всегда задавался вопросом: а как оно все происходит там, уровнем ниже, в «машинном отделении», так сказать? Одно дело понимать синтаксис и команды высокоуровневого языка программирования понятные человеку, а другое – хотя бы в общих чертах, представлять, как все устроено в более близком приближении. 
Если мы спустимся на «этаж» ниже от привычного нам уровня приложений, с понятным нам интерфейсом, то первым в чем предстоит нам разобраться – это взаимодействие памяти и процессора. Конечно, погружаться очень глубоко в данный вопрос в рамках данной статьи, так сказать, экспертно я не стану, но в общих чертах попробую описать, как, в первую очередь, понимаю это я. 
Допустим мы написали код некоторой программы. Наш код скомпилировался (для языков программирования использующих компилятор) в исполняемый файл (например, .EXE для семейства ОС Windows). Структуру готового исполняемого файла я привел ниже:

![](/image/exe-struct.jpg)

Как мы видим, EXE файл представляет собой сегменты с разным назначением. Данная структура делит нашу программу на сегмент данных и сегмент кода.
Память (ОЗУ) – это последовательность байт. Доступ к адресам памяти (ячейкам) может осуществляться как к одному непрерывному массиву (модель flat), или как к нескольким массивам (сегментированная модель).
И так, что же происходит при запуске программы? Операционная система (ОС) выделяет необходимый объем памяти. Другими словами – создается процесс, то есть, выделяются и разграничивает ресурсы. Затем, ОС загружает в выделенную область памяти нашу программу, которая представляет из себя набор данных и команд (инструкций). Далее происходит передача управления нашей программе, то есть, выполнение инструкций. Другими словами, создается поток. Поток использует ресурсы процесса и определяет последовательность исполнения кода. 

![](/image/flow.jpg)
Внутри одного процесса, может быть несколько потоков, и выполняться они могут параллельно. Например всем известная функция main() запускает главный поток. Остальные потоки запускаются (создаются) при помощи других функций по мере необходимости, и усмотрению программиста в коде.
При загрузке процесса в ОЗУ, формируется адресное пространство этого процесса, которое состоит из различных сегментов. Ниже на схеме, я попытался доступно это отразить:

![](/image/memory_process.jpg)

Теперь мы понимаем, как устроена организация ресурсов памяти, а вот как происходят операции над данными, которые там хранятся? Иначе говоря, мы рассмотрели структуру склада данных, но еще не видели организацию цеха по переработке этих данных :) Представленная ниже схема – архитектура ЭВМ, она очень упрощена для удобства понимания:

![](/image/EVM-architekt.jpg)

И так, наши данные (программа) записывается в ОЗУ, далее она частями считывается и значения, которые требуют обработки, по средствам системной шины, поступают в кэш-память процессора (CPU). Да, помимо ОЗУ, у процессора есть своя память. Она на много меньше по объему, но гораздо (во много раз) быстрее ОЗУ. Так сказать, свой собственный сверхбыстрый буфер. Далее команды и инструкции разделяются, и все дальнейшие операции производятся при помощи регистров процессора. Дело в том, что процессор работает только с собственными регистрами. Напрямую с ОЗУ он не взаимодействует. Все идущее ниже по тексту, будет рассмотрено на примере архитектуры процессоров семейства x86.
Регистры – специальное место (ячейки памяти внутри процессора) где хранятся значения, записанные из программы (ОЗУ) по средствам системной шины, для которых необходимо сделать какие-либо вычисления. Доступ осуществляется по имени.
После включения, процессор находится в режиме реальной адресации. Это режим, при котором любому процессу доступна вся память компьютера. При загрузке операционной системы, ОС переводит процессор в защищенный режим, при котором доступ к ресурсам для различных процессов разграничиваются и контролируются самой ОС.

Бит – минимальная единица памяти, которой оперирует процессор. 1 байт = 8 бит и это составляет 1 «слово». И так, 1 слово = 8 бит = 1 байт или 2^8 = 256 значений. Существуют также двойные слова и т.д.

2 слова = 2^16 = 65 535 

3 слова = 2^32 = 4 294 967 295

Байт, слово, двойное слово – это основные типы данных процессора. Для представления знака (отрицательное или положительное число) используется инверсия, а затем ко всем полученным битам прибавляется 1.
Для операций с плавающей точкой используется специальное устройство (FPU) внутри основного процессора с собственными регистрами и набором команд.

По назначению регистры различаются на:
* аккумулятор — используется для хранения промежуточных результатов арифметических и логических операций и инструкций ввода-вывода;
* флаговые — хранят признаки результатов арифметических и логических операций;
* общего назначения — хранят операнды арифметических и логических выражений, индексы и адреса;
* индексные — хранят индексы исходных и целевых элементов массива;
* указательные — хранят указатели на специальные области памяти (указатель текущей операции, указатель базы, указатель стека);
* сегментные — хранят адреса и селекторы сегментов памяти;
* управляющие — хранят информацию, управляющую состоянием процессора, а также адреса системных таблиц.

Кроме того процессор содержит наборы команд и инструкций. Например, расширения MMX. Это встроенный набор инструкций для более эффективной работы с большим потоком данных (изображения, видео, звук). По сити это несколько новых типов данных, регистров и команд для повышения производительности.

Данные, требующие обработки поступают в регистры процессора, который далее производит над ними, виде машинных слов, необходимые операции и возвращает полученные значения обратно программе.
Собственно, если очень упрощенно и простыми словами описать, что происходит с запущенной программой, то пожалуй на этом можно остановиться. Представленная мной информация является моим субъективным упрощенным пониманием, и я прекрасно понимаю, что на самом деле все устроено гораздо сложнее. 







